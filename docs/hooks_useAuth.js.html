<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: hooks/useAuth.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: hooks/useAuth.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Хук для управления аутентификацией пользователя.
 * Предоставляет методы для входа, регистрации и выхода, а также состояние пользователя.
 * @module useAuth
 */

import { useState, useEffect } from 'react';
import { supabase, auth } from '../lib/supabase';
import logger from '../utils/logger';
import { toast } from 'react-toastify';

/**
 * Хук аутентификации.
 * Управляет состоянием пользователя и предоставляет методы аутентификации.
 * @returns {Object} Объект с методами и состоянием аутентификации
 * @returns {Object|null} user - Текущий пользователь с данными профиля или null, если не авторизован
 * @returns {boolean} loading - Флаг состояния загрузки (true во время операций)
 * @returns {Function} signIn - Функция для входа пользователя
 * @returns {Function} signUp - Функция для регистрации пользователя
 * @returns {Function} signOut - Функция для выхода пользователя
 * @returns {boolean} isAuthenticated - Флаг, указывающий, авторизован ли пользователь
 */
export function useAuth() {
    const [user, setUser] = useState(null);
    const [loading, setLoading] = useState(true);

    /**
     * Инициализирует состояние пользователя и подписывается на изменения состояния аутентификации.
     */
    useEffect(() => {
        const fetchUser = async () => {
            try {
                const currentUser = await auth.getCurrentUser();
                setUser(currentUser);
            } catch (error) {
                logger.error('Failed to fetch current user:', error.message);
            } finally {
                setLoading(false);
            }
        };
        fetchUser();

        const { data: authListener } = supabase.auth.onAuthStateChange((event, session) => {
            if (event === 'SIGNED_OUT' || !session) {
                setUser(null);
            } else if (session?.user) {
                setUser({ ...session.user, profile: session.user.profile });
            }
            setLoading(false);
        });

        return () => authListener.subscription.unsubscribe();
    }, []);

    /**
     * Выполняет вход пользователя.
     * @async
     * @param {string} email - Электронная почта пользователя
     * @param {string} password - Пароль пользователя
     * @returns {Promise&lt;{success: boolean, message: string, user?: Object}>} Результат операции входа
     */
    const signIn = async (email, password) => {
        try {
            setLoading(true);
            const { user: signedInUser, profile } = await auth.signIn(email, password);
            const updatedUser = { ...signedInUser, profile };
            setUser(updatedUser); // Синхронно обновляем user
            logger.info(`Player ${profile.username} signed in`);
            toast.success('Вход выполнен', { position: 'top-right', autoClose: 3000 });
            return { success: true, message: 'Вход выполнен', user: updatedUser };
        } catch (error) {
            logger.error('Sign-in error:', error.message);
            toast.error(`Ошибка входа: ${error.message}`);
            return { success: false, message: error.message };
        } finally {
            setLoading(false);
        }
    };

    /**
     * Регистрирует нового пользователя.
     * @async
     * @param {string} email - Электронная почта пользователя
     * @param {string} password - Пароль пользователя
     * @param {string} username - Имя пользователя
     * @returns {Promise&lt;{success: boolean, message: string}>} Результат операции регистрации
     */
    const signUp = async (email, password, username) => {
        try {
            setLoading(true);
            const { profile } = await auth.signUp(email, password, username);
            logger.info(`Player ${username} registered`);
            await supabase.auth.signOut();
            setUser(null);
            toast.success('Регистрация успешна! Теперь вы можете войти', {
                position: 'top-right',
                autoClose: 3000,
            });
            return { success: true, message: 'Регистрация успешна! Теперь вы можете войти' };
        } catch (error) {
            logger.error('Sign-up error:', error.message);
            await supabase.auth.signOut();
            setUser(null);
            toast.error(`Ошибка регистрации: ${error.message}`);
            return { success: false, message: error.message };
        } finally {
            setLoading(false);
        }
    };

    /**
     * Выполняет выход пользователя.
     * @async
     * @returns {Promise&lt;{success: boolean, message: string}>} Результат операции выхода
     */
    const signOut = async () => {
        try {
            setLoading(true);
            await auth.signOut();
            logger.info(`Player ${user?.profile?.username || 'unknown'} signed out`);
            setUser(null);
            return { success: true, message: 'Выход выполнен' };
        } catch (error) {
            logger.error('Sign-out error:', error.message);
            toast.error(`Ошибка выхода: ${error.message}`);
            return { success: false, message: error.message };
        } finally {
            setLoading(false);
        }
    };

    return { user, loading, signIn, signUp, signOut, isAuthenticated: !!user };
}</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-App.html">App</a></li><li><a href="module-AuthForm.html">AuthForm</a></li><li><a href="module-ClientConfig.html">ClientConfig</a></li><li><a href="module-EventBus.html">EventBus</a></li><li><a href="module-GameScene.html">GameScene</a></li><li><a href="module-HexGrid.html">HexGrid</a></li><li><a href="module-Main.html">Main</a></li><li><a href="module-PhaserGame.html">PhaserGame</a></li><li><a href="module-PhaserMain.html">PhaserMain</a></li><li><a href="module-logger.html">logger</a></li><li><a href="module-supabase.html">supabase</a></li><li><a href="module-useAuth.html">useAuth</a></li></ul><h3>Namespaces</h3><ul><li><a href="module-supabase-auth.html">auth</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a> on Tue Mar 18 2025 21:51:00 GMT+0300 (Москва, стандартное время)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
