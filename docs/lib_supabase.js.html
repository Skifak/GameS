<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: lib/supabase.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: lib/supabase.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Модуль для работы с Supabase.
 * Предоставляет клиент Supabase и методы для аутентификации и управления профилем.
 * @module supabase
 */

import { createClient } from '@supabase/supabase-js';

const supabaseUrl = import.meta.env.VITE_SUPABASE_PUBLIC_URL;
const supabaseAnonKey = import.meta.env.VITE_ANON_KEY;

if (!supabaseUrl || !supabaseAnonKey) {
    throw new Error('Supabase URL and Anon Key must be provided in .env');
}
export const createSupabaseClient = (url, key) => {
    return createClient(url, key);
  };
/**
 * Клиент Supabase для взаимодействия с базой данных и аутентификацией.
 * @type {import('@supabase/supabase-js').SupabaseClient}
 */
export const supabase = createClient(supabaseUrl, supabaseAnonKey, {
    auth: {
        autoRefreshToken: true,
        persistSession: true,
        detectSessionInUrl: false,
    },
});

/**
 * Объект методов для аутентификации и управления профилем в Supabase.
 * @namespace auth
 */
export const auth = {
    /**
     * Регистрирует нового пользователя в Supabase и создаёт профиль.
     * @async
     * @param {string} email - Электронная почта пользователя
     * @param {string} password - Пароль пользователя
     * @param {string} username - Имя пользователя (3-20 символов, только буквы и цифры)
     * @returns {Promise&lt;{user: Object, profile: Object, session: Object}>} Объект с данными пользователя, профиля и сессии
     * @throws {Error} Если регистрация или создание профиля не удались
     */
    async signUp(email, password, username) {
        const { data, error } = await supabase.auth.signUp({ email, password });
        if (error) throw new Error(error.message);

        const { data: profileData, error: profileError } = await supabase
            .from('profiles')
            .insert({
                id: data.user.id,
                username,
                email,
                role: 'player',
                created_at: new Date().toISOString(),
                last_login: new Date().toISOString(),
                status: 'online',
            })
            .select()
            .single();

        if (profileError) throw new Error(profileError.message);
        return { user: data.user, profile: profileData, session: data.session };
    },

    /**
     * Выполняет вход пользователя в Supabase и обновляет или создаёт профиль.
     * @async
     * @param {string} email - Электронная почта пользователя
     * @param {string} password - Пароль пользователя
     * @returns {Promise&lt;{user: Object, profile: Object, session: Object}>} Объект с данными пользователя, профиля и сессии
     * @throws {Error} Если вход или работа с профилем не удались
     */
    async signIn(email, password) {
        const { data, error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) throw new Error(error.message);

        // Проверяем, существует ли профиль
        const { data: profileData, error: profileError } = await supabase
            .from('profiles')
            .select('*')
            .eq('id', data.user.id)
            .single();

        let profile;
        if (profileError &amp;&amp; profileError.code === 'PGRST116') {
            // Если профиля нет (PGRST116 - no rows returned), создаём новый
            const { data: newProfile, error: insertError } = await supabase
                .from('profiles')
                .insert({
                    id: data.user.id,
                    username: email.split('@')[0], // Используем часть email как временное имя если нет ввода username
                    email,
                    role: 'player',
                    created_at: new Date().toISOString(),
                    last_login: new Date().toISOString(),
                    status: 'online',
                })
                .select()
                .single();
            if (insertError) throw new Error(insertError.message);
            profile = newProfile;
        } else if (profileError) {
            throw new Error(profileError.message);
        } else {
            // Если профиль есть, обновляем last_login и status
            const { data: updatedProfile, error: updateError } = await supabase
                .from('profiles')
                .update({ last_login: new Date().toISOString(), status: 'online' })
                .eq('id', data.user.id)
                .select()
                .single();
            if (updateError) throw new Error(updateError.message);
            profile = updatedProfile;
        }

        return { user: data.user, profile, session: data.session };
    },

    /**
     * Выполняет выход пользователя из Supabase и обновляет статус в профиле.
     * @async
     * @returns {Promise&lt;void>}
     * @throws {Error} Если выход не удался
     */
    async signOut() {
        const { data: { user } } = await supabase.auth.getUser();
        if (user) {
            await supabase.from('profiles').update({ status: 'offline' }).eq('id', user.id);
        }
        const { error } = await supabase.auth.signOut();
        if (error) throw new Error(error.message);
    },

    /**
     * Получает данные текущего пользователя и его профиля.
     * @async
     * @returns {Promise&lt;Object|null>} Объект с данными пользователя и профиля или null, если пользователь не авторизован
     * @throws {Error} Если запрос профиля не удался
     */
    async getCurrentUser() {
        const { data: { user }, error } = await supabase.auth.getUser();
        if (error || !user) return null;

        const { data: profile, error: profileError } = await supabase
            .from('profiles')
            .select('*')
            .eq('id', user.id)
            .single();

        if (profileError) throw new Error(profileError.message);
        return { ...user, profile };
    },
};</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-App.html">App</a></li><li><a href="module-AuthForm.html">AuthForm</a></li><li><a href="module-ClientConfig.html">ClientConfig</a></li><li><a href="module-EventBus.html">EventBus</a></li><li><a href="module-GameScene.html">GameScene</a></li><li><a href="module-HexGrid.html">HexGrid</a></li><li><a href="module-Main.html">Main</a></li><li><a href="module-PhaserGame.html">PhaserGame</a></li><li><a href="module-PhaserMain.html">PhaserMain</a></li><li><a href="module-logger.html">logger</a></li><li><a href="module-supabase.html">supabase</a></li><li><a href="module-useAuth.html">useAuth</a></li></ul><h3>Namespaces</h3><ul><li><a href="module-supabase-auth.html">auth</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a> on Tue Mar 18 2025 21:51:00 GMT+0300 (Москва, стандартное время)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
