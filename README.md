test@example.com
password123


# GameST

Многопользовательская игра на базе Phaser.js и React с серверной частью на Node.js и Colyseus.

text

Свернуть

Перенос

Копировать
test@example.com
password123

# GameST

Многопользовательская игра на базе Phaser.js и React с серверной частью на Node.js и Colyseus.

## Содержание

- [Структура проекта](#структура-проекта)
- [Окружения разработки](#окружения-разработки)
- [Установка и запуск](#установка-и-запуск)
  - [Требования](#требования)
  - [Локальная разработка](#локальная-разработка)
  - [Запуск с Docker](#запуск-с-docker)
- [Доступные скрипты](#доступные-скрипты)
  - [Разработка](#разработка)
  - [Сборка и продакшн](#сборка-и-продакшн)
  - [Тестирование и качество кода](#тестирование-и-качество-кода)
  - [Утилиты](#утилиты)
- [Сборка для разных окружений](#сборка-для-разных-окружений)
  - [Development](#development)
  - [Production](#production)
- [Конфигурация окружений](#конфигурация-окружений)
  - [.env.local](#envlocal)
  - [.env.example](#envexample)
- [CI/CD](#cicd)
- [Безопасность и секреты](#безопасность-и-секреты)
  - [Локальная разработка](#локальная-разработка-1)
  - [CI/CD и деплой](#cicd-и-деплой)
- [Тестирование](#тестирование)
- [Линтинг и форматирование](#линтинг-и-форматирование)
- [Руководство по разработке и тестированию](#руководство-по-разработке-и-тестированию)
  - [Обзор стека технологий](#обзор-стека-технологий)
  - [Варианты запуска для разработки](#варианты-запуска-для-разработки)
    - [Локальная разработка (рекомендуется для начала)](#локальная-разработка-рекомендуется-для-начала)
    - [Полный стек через Docker Compose](#полный-стек-через-docker-compose)
  - [Пошаговое руководство по началу разработки](#пошаговое-руководство-по-началу-разработки)
    - [Шаг 1: Подготовка окружения](#шаг-1-подготовка-окружения)
    - [Шаг 2: Запуск в режиме разработки](#шаг-2-запуск-в-режиме-разработки)
    - [Шаг 3: Изучение структуры проекта](#шаг-3-изучение-структуры-проекта)
    - [Шаг 4: Тестирование полного стека](#шаг-4-тестирование-полного-стека)
- [Доступ к инструментам мониторинга и управления](#доступ-к-инструментам-мониторинга-и-управления)
- [Решение проблем](#решение-проблем)
- [Развёртывание и обслуживание сервера](#развёртывание-и-обслуживание-сервера)
  - [Запуск сайта на сервере](#запуск-сайта-на-сервере)
  - [Мониторинг и управление сервисами](#мониторинг-и-управление-сервисами)

## Структура проекта

## Структура проекта

GameST/
├── .github/                    # GitHub Actions и конфигурация CI/CD
├── .vscode/                    # Настройки VS Code
├── dist/                       # Скомпилированные файлы для продакшн
├── logs/                       # Логи приложения
├── public/                     # Статические файлы
├── server/                     # Серверная часть (Node.js + Colyseus)
│   ├── auth.js                # Аутентификация и авторизация
│   ├── config.js              # Конфигурация сервера
│   ├── index.js               # Точка входа сервера
│   └── logger.js              # Настройка логирования
├── src/                        # Клиентская часть (React + Phaser)
│   ├── components/            # React компоненты
│   ├── game/                  # Игровая логика на Phaser
│   ├── hooks/                 # React хуки
│   ├── lib/                   # Общие библиотеки
│   ├── utils/                 # Утилиты
│   ├── App.jsx                # Главный компонент React
│   ├── main.jsx              # Точка входа клиента
│   └── env.d.ts              # Типы для переменных окружения
├── storage/                    # Локальное хранилище файлов
├── supabase/                   # Конфигурация и миграции Supabase
├── volumes/                    # Данные Docker контейнеров
├── vite/                      # Конфигурация и плагины Vite
├── scripts/                    # Скрипты для разработки и деплоя
├── .dockerignore              # Исключения для Docker
├── .editorconfig              # Настройки редактора кода
├── .env                       # Переменные окружения для продакшн
├── .env.example               # Пример переменных окружения
├── .env.local                 # Локальные переменные окружения
├── .eslintrc.cjs             # Конфигурация ESLint
├── .gitignore                # Исключения для Git
├── CHANGELOG.md              # История изменений
├── Dockerfile                # Конфигурация Docker образа
├── LICENSE.md                # Лицензия проекта (MIT)
├── README.md                 # Документация проекта
├── docker-compose.yml        # Конфигурация Docker Compose
├── jest.config.js           # Конфигурация Jest для тестов
├── loki-config.yml          # Конфигурация Loki для логов
├── nginx.conf               # Конфигурация Nginx для продакшн
├── nginx.dev.conf           # Конфигурация Nginx для разработки
├── package.json             # Зависимости и скрипты npm
├── prometheus.yml           # Конфигурация Prometheus
└── vite.config.js          # Конфигурация Vite

## Окружения разработки

Проект поддерживает два окружения:

1. **Development** - для локальной разработки (использует `.env.local`)
2. **Production** - для конечных пользователей (использует `.env` на основе `.env.example` + GitHub Secrets)

## Установка и запуск

### Требования

- Node.js 20+
- Docker и Docker Compose
- Git

### Локальная разработка

1. Клонировать репозиторий:
   ```
   git clone https://github.com/yourusername/GameST.git
   cd GameST
   ```

2. Установить зависимости:
   ```
   npm install
   ```

3. Файл `.env.local` уже настроен для локальной разработки. Убедитесь, что он содержит все необходимые переменные.

4. Запустить в режиме разработки:
   ```
   # Запустить клиент и сервер одновременно
   npm run start:dev
   
   # Или запустить отдельно
   npm run dev        # Только клиент
   npm run server:dev # Только сервер
   ```

### Запуск с Docker

```
docker-compose up -d
```

## Доступные скрипты

### Разработка
- `npm run dev` - запуск клиента в режиме разработки
- `npm run server:dev` - запуск сервера в режиме разработки
- `npm run start:dev` - одновременный запуск клиента и сервера в режиме разработки

### Сборка и продакшн
- `npm run build` - сборка клиента для продакшн
- `npm run build:dev` - сборка клиента для разработки
- `npm run server:prod` - запуск сервера в продакшн режиме
- `npm run start:prod` - запуск продакшн сервера
- `npm run preview` - предпросмотр собранного клиента

### Тестирование и качество кода
- `npm test` - запуск тестов
- `npm run test:watch` - запуск тестов в режиме наблюдения
- `npm run test:coverage` - запуск тестов с отчетом о покрытии
- `npm run lint` - проверка кода линтером
- `npm run lint:fix` - исправление ошибок линтера
- `npm run format` - форматирование кода

### Утилиты
- `npm run prepare-env` - создание .env файла из .env.example

## Сборка для разных окружений

### Development

```
npm run build:dev
```

### Production

```
npm run build
```

## Конфигурация окружений

Проект использует два основных файла конфигурации:

### .env.local

Используется для **локальной разработки**. Этот файл не должен быть закоммичен в репозиторий и содержит настройки для локальной среды разработки, включая тестовые секретные данные.

### .env.example

Шаблон для создания `.env` файла для **production** среды. Содержит только несекретные настройки. При деплое через CI/CD:
1. Создается `.env` файл на основе `.env.example`
2. Секретные данные добавляются из GitHub Secrets
3. Полученный файл используется для запуска приложения

## CI/CD

Проект использует GitHub Actions для автоматического развертывания:

- Пуш в ветку `develop` -> деплой в окружение Development
- Пуш в ветку `main` -> деплой в окружение Production

## Безопасность и секреты

### Локальная разработка

Для локальной разработки используется файл `.env.local`, который содержит тестовые секретные данные. **Никогда не коммитьте этот файл в репозиторий!**

### CI/CD и деплой

Для CI/CD используются секреты, хранящиеся в GitHub Secrets:

1. **Для Production:**
   - `JWT_SECRET`
   - `PB_ADMIN_EMAIL`
   - `PB_ADMIN_PASSWORD`
   - `DEPLOY_KEY` (SSH-ключ для деплоя)

2. **Для Development:**
   - `JWT_SECRET_DEV`
   - `PB_ADMIN_EMAIL_DEV`
   - `PB_ADMIN_PASSWORD_DEV`

Эти секреты добавляются в `.env` файл во время CI/CD процесса и никогда не хранятся в репозитории.

## Тестирование

```
# Запуск всех тестов
npm test

# Запуск тестов в режиме наблюдения
npm run test:watch

# Запуск тестов с отчетом о покрытии
npm run test:coverage
```

## Линтинг и форматирование

```
# Проверка кода линтером
npm run lint

# Исправление ошибок линтера
npm run lint:fix

# Форматирование кода
npm run format
```

## Руководство по разработке и тестированию

### Обзор стека технологий

Проект использует следующие технологии:

1. **Клиентская часть**:
   - React для пользовательского интерфейса
   - Phaser.js для игровой механики
   - Vite для сборки и разработки

2. **Серверная часть**:
   - Node.js как основа
   - Colyseus для многопользовательской синхронизации
   - Winston для логирования

3. **Инфраструктура**:
   - Redis для кэширования и обмена сообщениями
   - NATS для асинхронной коммуникации
   - Supabase для хранения данных и аутентификации
   - Prometheus и Grafana для мониторинга
   - Loki для централизованного логирования
   - Nginx как прокси-сервер

### Варианты запуска для разработки

#### 1. Локальная разработка (рекомендуется для начала)

Этот вариант запускает только клиент и сервер без дополнительных сервисов:

```bash
npm run start:dev
```

Это запустит:
- Клиент на порту 3000 (или 3001, если 3000 занят)
- Сервер на порту 2567

Преимущества:
- Быстрый запуск
- Меньше ресурсов
- Удобно для разработки клиентской части и базовой логики сервера

#### 2. Полный стек через Docker Compose

Этот вариант запускает все сервисы, включая Redis, NATS, Supabase и т.д.:

```bash
docker-compose up -d
```

Затем вы можете запустить клиент отдельно:

```bash
npm run dev
```

Преимущества:
- Полная среда, идентичная продакшену
- Доступны все сервисы для тестирования
- Можно тестировать мониторинг и логирование

### Пошаговое руководство по началу разработки

#### Шаг 1: Подготовка окружения

1. Убедитесь, что у вас установлены все требования (Node.js, Docker, Git)
2. Проверьте наличие файла `.env.local` с настройками для разработки

#### Шаг 2: Запуск в режиме разработки

```bash
npm run start:dev
```

Это запустит клиент и сервер одновременно. Вы увидите:
- Клиент доступен по адресу http://localhost:3000/
- Сервер запущен на порту 2567

#### Шаг 3: Изучение структуры проекта

- `src/` - клиентская часть (React + Phaser)
  - `src/components/` - React компоненты
  - `src/game/` - Phaser игра
  - `src/utils/` - утилиты

- `server/` - серверная часть
  - `server/index.js` - основной файл сервера
  - `server/config.js` - конфигурация
  - `server/logger.js` - настройки логирования

#### Шаг 4: Тестирование полного стека

1. Остановите локальную разработку (Ctrl+C)
2. Запустите полный стек:
   ```bash
   docker-compose up -d
   ```
3. Проверьте доступность сервисов:
   - PocketBase: http://localhost:8090/
   - Grafana: http://localhost:3000/
   - Prometheus: http://localhost:9090/
   - Loki: http://localhost:3100/
   - Redis: порт 6379
   - NATS: порт 4222

4. Запустите клиент отдельно:
   ```bash
   npm run dev
   ```

### Доступ к инструментам мониторинга и управления

При запуске через Docker Compose:

1. **PocketBase** (база данных):
   - URL: http://localhost:8090/
   - Логин: admin@example.com (из конфигурации)
   - Пароль: admin-password (из конфигурации)

2. **Grafana** (мониторинг):
   - URL: http://localhost:3000/
   - Логин: admin
   - Пароль: admin (по умолчанию)

3. **Prometheus** (метрики):
   - URL: http://localhost:9090/

### Решение проблем

1. **Порты уже заняты**:
   - Остановите все контейнеры: `docker-compose down`
   - Проверьте запущенные процессы: `docker ps`

2. **Ошибки подключения к сервисам**:
   - Проверьте, запущены ли все контейнеры: `docker-compose ps`
   - Проверьте логи: `docker-compose logs [service-name]`

3. **Проблемы с Docker**:
   - Перезапустите Docker Desktop
   - Очистите неиспользуемые ресурсы: `docker system prune`




# Supabase

   Обзор сервисов Supabase
Supabase состоит из множества сервисов, каждый из которых выполняет свою роль в экосистеме. Вот описание каждого из них, основанное на твоём выводе и docker-compose.yml:

1. db (PostgreSQL)
Описание: Основной сервис базы данных PostgreSQL. Это ядро Supabase, где хранятся все данные. Supabase расширяет PostgreSQL дополнительными схемами и функциями для поддержки реального времени, аутентификации и других возможностей.
Размер: ~660 MB (как указано в твоём выводе).
Необходимость: Обязателен. Без него ничего работать не будет, так как это основа всей системы.
Оптимизация: Если памяти мало, можно уменьшить настройки PostgreSQL (например, shared_buffers, work_mem) в файле volumes/db/postgresql.conf (если он монтируется), но это может повлиять на производительность.
2. meta (Postgres Meta)
Описание: Сервис для управления метаданными базы данных (схемы, таблицы, функции и т.д.). Используется Supabase Studio для предоставления интерфейса управления базой данных.
Необходимость: Нужен, если ты используешь Supabase Studio для администрирования. Если ты не планируешь использовать Studio или будешь управлять базой через другие инструменты (например, pgAdmin или CLI), можешь отключить.
Оптимизация: Отключи, если не нужен Studio. Для отключения закомментируй или удали секцию meta в docker-compose.yml.
3. analytics (Logflare)
Описание: Сервис для логирования и аналитики (Logflare). Собирает логи из других сервисов Supabase и позволяет анализировать их (например, через Studio или внешние инструменты). Может работать с PostgreSQL или Big Query как бэкенд.
Необходимость: Не обязателен, если у тебя уже есть система логирования (например, Loki из твоего основного стека). Ты можешь перенаправить логи Supabase в Loki и отключить этот сервис.
Оптимизация: Отключи, если не нужен. Для этого закомментируй или удали секцию analytics в docker-compose.yml. Также убедись, что другие сервисы не зависят от него (например, studio и auth могут зависеть от analytics для проверки состояния).
4. imgproxy
Описание: Сервис для обработки изображений (Imgproxy). Используется для динамической обработки и оптимизации изображений, загружаемых через Supabase Storage.
Необходимость: Нужен только если ты используешь Supabase Storage и тебе требуется обработка изображений (например, изменение размеров, форматов). Если ты не используешь Storage или не нуждаешься в обработке изображений, можешь отключить.
Оптимизация: Отключи, если не нужен. Для этого закомментируй или удали секцию imgproxy в docker-compose.yml. Также проверь зависимости в сервисе storage.
5. functions (Edge Functions)
Описание: Сервис для выполнения серверлесс-функций (Edge Functions). Позволяет писать кастомные функции на JavaScript/TypeScript и запускать их в изолированной среде.
Необходимость: Не обязателен, если ты не планируешь использовать серверлесс-функции. Если тебе достаточно REST API и прямых запросов к базе, можешь отключить.
Оптимизация: Отключи, если не нужен. Для этого закомментируй или удали секцию functions в docker-compose.yml.
6. vector
Описание: Сервис для сбора и передачи логов (Vector). Используется для маршрутизации логов из контейнеров Supabase в Logflare (analytics) или другие системы.
Необходимость: Не обязателен, если у тебя уже есть система логирования (например, Loki и Promtail в твоём основном стеке). Ты можешь перенаправить логи Supabase в Loki и отключить Vector.
Оптимизация: Отключи, если не нужен. Для этого закомментируй или удали секцию vector в docker-compose.yml. Также проверь зависимости (например, db зависит от vector для проверки состояния — убедись, что это не сломает запуск).
7. auth (GoTrue)
Описание: Сервис для аутентификации и авторизации (GoTrue). Отвечает за регистрацию, вход, управление пользователями, OAuth и токенами JWT.
Необходимость: Обязателен, если тебе нужна аутентификация пользователей (например, для игры). Если ты не планируешь использовать встроенную аутентификацию Supabase, можешь отключить, но это редко имеет смысл.
Оптимизация: Если аутентификация не нужна, закомментируй или удали секцию auth в docker-compose.yml.
8. supavisor (Supavisor)
Описание: Сервис для пулинга соединений (Supavisor). Оптимизирует подключения к PostgreSQL, особенно полезен при большом количестве клиентов.
Необходимость: Не обязателен для небольших проектов или если ты не ожидаешь высокой нагрузки. Для твоей игры он может быть полезен, если будет много одновременных подключений к базе.
Оптимизация: Отключи, если нагрузка небольшая. Для этого закомментируй или удали секцию supavisor в docker-compose.yml.
9. rest (PostgREST)
Описание: Сервис для предоставления REST API (PostgREST). Преобразует PostgreSQL в RESTful API, через который ты и твой фронтенд будете работать.
Необходимость: Обязателен. Это основной способ взаимодействия с базой через REST API, который ты выбрал.
Оптимизация: Нельзя отключить, так как это ключевой компонент для твоего подхода.
10. storage
Описание: Сервис для хранения файлов (Supabase Storage). Позволяет загружать, хранить и управлять файлами (например, аватары, изображения для игры).
Необходимость: Не обязателен, если ты не планируешь хранить файлы через Supabase. Если тебе достаточно базы данных, можешь отключить.
Оптимизация: Отключи, если не нужен. Для этого закомментируй или удали секцию storage в docker-compose.yml. Также отключи зависимости (например, imgproxy).
11. kong
Описание: API-шлюз (Kong). Управляет маршрутизацией запросов к различным сервисам Supabase (REST API, Realtime, Auth и т.д.).
Необходимость: Обязателен. Это точка входа для REST API и других сервисов.
Оптимизация: Нельзя отключить, так как это ключевой компонент для маршрутизации.
12. studio
Описание: Веб-интерфейс для управления Supabase (Supabase Studio). Позволяет управлять базой данных, пользователями, таблицами и т.д. через браузер.
Необходимость: Не обязателен, если ты можешь управлять базой через CLI или другие инструменты (например, pgAdmin).
Оптимизация: Отключи, если не нужен. Для этого закомментируй или удали секцию studio в docker-compose.yml. Также отключи зависимости (например, meta).
13. realtime
Описание: Сервис для работы в реальном времени (Realtime). Поддерживает подписки на изменения в базе данных через WebSocket.
Необходимость: Не обязателен, если тебе не нужны подписки в реальном времени (например, для обновления данных в игре без перезагрузки). Для твоей игры он может быть полезен, если ты хочешь моментальные обновления (например, чат или изменения состояния).
Оптимизация: Отключи, если не нужен. Для этого закомментируй или удали секцию realtime в docker-compose.yml.