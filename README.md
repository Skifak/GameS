# Технический README браузерной игры GameST.

## Общее описание:
Проект представляет собой веб-приложение с игрой на базе Phaser.js, интегрированное с React. Архитектура включает клиентскую часть (React + Phaser) и серверную часть. Проект использует современный стек технологий и инструментов для разработки, мониторинга и развертывания.

### Основные сервисы

1.**Клиентская часть (Frontend)**:
- **React-приложение** - основной интерфейс пользователя
- **Phaser.js** - игровой движок для создания 2D-игр
- **Vite** - инструмент сборки и разработки

2.**Серверная часть (Backend)**:
- **Node.js + Express** - серверный фреймворк
- **Colyseus** - фреймворк для многопользовательских игр
- **Supabase** - база данных и система аутентификации
- **Redis** - хранилище данных в памяти
- **NATS** - система обмена сообщениями

3. **Supabase-стек**:
   - **supabase-db (PostgreSQL)** - реляционная база данных для хранения данных приложения.
   - **supabase-auth (GoTrue)** - система аутентификации и управления пользователями.
   - **supabase-studio** - веб-интерфейс для управления базой данных и пользователями.
   - **supabase-meta** - метаданные и схемы базы данных.
   - **supabase-realtime** - система для обработки и передачи данных в реальном времени.
   - **storage** - объектное хранилище для файлов и медиа.

4. **Инфраструктура, мониторинг и логирование**:
- **Docker** - контейнеризация приложения
- **Nginx** - веб-сервер и прокси
- **Prometheus** - система мониторинга
- **Grafana** - визуализация метрик
- **Loki** - система сбора и анализа логов

5. **CI/CD**:
   - **GitHub Actions** - автоматизация сборки и развертывания
   - **SSH-деплой** - развертывание на удаленный сервер через SSH

### Развертывание

- Docker Compose для оркестрации контейнеров во всех трех средах
- Nginx для маршрутизации запросов
- Поддержка различных окружений (develop/stage/prod)
- GitHub Actions для автоматизации процесса развертывания
- SSH для безопасной передачи файлов и выполнения команд на сервере

### Список сервисов используемых в локальной среде:

1. **Клиентская часть (Frontend)**:
   - **React-приложение** - основной интерфейс пользователя
   - **Phaser.js** - игровой движок для создания 2D-игр
   - **Vite** - инструмент сборки и разработки

2. **Серверная часть (Backend)**:
   - **Node.js + Express** - серверный фреймворк
   - **Colyseus** - фреймворк для многопользовательских игр
   - **Supabase** - база данных и система аутентификации
   - **Redis** - хранилище данных в памяти
   - **NATS** - система обмена сообщениями

3. **Supabase-стек**:
   - **supabase-db (PostgreSQL)** - реляционная база данных для хранения данных приложения.
   - **supabase-auth (GoTrue)** - система аутентификации и управления пользователями.
   - **supabase-studio** - веб-интерфейс для управления базой данных и пользователями.
   - **supabase-meta** - метаданные и схемы базы данных.
   - **supabase-realtime** - система для обработки и передачи данных в реальном времени.
   - **storage** - объектное хранилище для файлов и медиа.

### Клиентская часть

Структура `/src`:
- `components/` - React компоненты
   - AuthForm.jsx - форма аутентификации и регистрации с переключением между режимами входа и создания аккаунта.
   - PlayerController.js - класс для управления позицией игрока в Phaser-сцене, отвечает за обновление координат и анимацию перемещения.
   - UIManager.js - класс для управления интерфейсом в Phaser-сцене, отображает текстовые статусы (например, подключение к серверу).
- `game/` - PhaserGame.jsx игровая логика
   - CommandSender.js - класс для отправки команд на сервер Colyseus (например, перемещение к точке интереса) через событийную шину.
   - ConnectionManager.js - класс для управления подключением к комнатам Colyseus, включая создание или присоединение к комнатам с использованием Supabase-токенов.
   - EventBus.js - событийная шина на основе Phaser.Events.EventEmitter для взаимодействия между React и Phaser.
   - GameStateManager.js - класс для управления состоянием игры, включая инициализацию подключения, обновление позиции игрока и запросы перемещения.
   - MapDataManager.js - класс для загрузки и кэширования данных карты (гексы и точки интереса) из Supabase.
   - MessageHandler.js - класс для обработки сообщений от сервера Colyseus, таких как перемещение игрока или смена комнаты.
   - PhaserGame.jsx - React-компонент для интеграции Phaser, создает и уничтожает игру, передает активную сцену через ref.
   - main.js - инициализация Phaser с конфигурацией и запуском основной сцены Game.
   - `scenes/` - сцены игры
      - Game.js - основная игровая сцена, инициализирует подключение к Colyseus, отображает фон и управляет игроком.
      - HexGrid.js - сцена для отображения гексагональной сетки и точек интереса, поддерживает интерактивное перемещение.
- `hooks/` - React хуки
   - seAuth.js - хук для управления аутентификацией через Supabase, предоставляет методы входа, регистрации и выхода.
- `lib/` - общие библиотеки
   - supabase.js - инициализация клиента Supabase и методы аутентификации (signUp, signIn, signOut, getCurrentUser).
- `utils/` - утилиты
   - config.js - конфигурация клиента с переменными окружения для разных сред.
   - logger.js - простой логгер для клиентской части с выводом в консоль.
- App.jsx - корневой компонент, управляющий аутентификацией и отображением игры или формы входа.
- main.jsx - точка входа React-приложения, рендерит App.

### Серверная часть

Структура `/server`:
   - admin.js - API для администрирования карты, предоставляет эндпоинты для управления гексами и точками интереса (требуется роль администратора).
   - config.js - конфигурация сервера, загружает переменные окружения и определяет настройки для разных сред (dev/prod).
   - index.js - точка входа сервера, настраивает Express, Colyseus и мониторинг, регистрирует комнату PointRoom.
   - logger.js - настройка логирования с использованием Winston, включая вывод в консоль, файлы и Loki (в продакшене).
   - metrics.js - настройка метрик Prometheus для мониторинга активных сессий, задержек и ошибок.
   - pointRoom.js - класс комнаты Colyseus для управления точками интереса, синхронизирует состояние игроков и обрабатывает перемещения.
   - redisService.js - сервис для работы с Redis, управляет сессиями игроков (сохранение, получение, удаление).

### CI/CD Процесс
1. **deploy.yml** - конфигурация GitHub Actions для автоматического развертывания
   - Запускается при пуше в ветки main и stage на разные сервера в зависимости от ветки.
   - Собирает клиентскую часть приложения с помощью vite.
   - Развертывает на соответствующий сервер через SSH
   - Перезапускает контейнеры Docker

## Технический анализ

### Аутентификация
- Реализована система регистрации и входа через Supabase
- Используются JWT-токены с проверкой через Supabase SDK
- Отсутствует реализация эндпоинта для обновления токенов (/refresh)
- Хранение токенов осуществляется через Supabase SDK, но отсутствует явное использование HTTP-only куки с SameSite=Strict

### Многопользовательская игра
- Colyseus используется для синхронизации состояния игры между клиентами
- Реализована система комнат и подключения игроков
- Используется Redis для хранения состояния сессий (частично, требует доработки)
- Отсутствует создание новых комнат при переполнении текущей

### Логирование и мониторинг
- Winston для структурированного логирования
- Loki для централизованного хранения логов
- Prometheus для сбора метрик
- Grafana для визуализации

### Развертывание
- Docker Compose для оркестрации контейнеров
- Nginx для маршрутизации запросов
- Поддержка различных окружений (dev/stage/prod)
- GitHub Actions для автоматизации процесса развертывания
- SSH для безопасной передачи файлов и выполнения команд на сервере

## Окружения разработки

Проект поддерживает три окружения:

1. **Development** - для локальной разработки (dev, develop, development)
2. **Staging** - промежуточная среда для тестирования
3. **Production** - для конечных пользователей (использует .env + GitHub Secrets)

## Сильные стороны проекта

1. **Современный стек технологий** - использование актуальных инструментов и библиотек
2. **Хорошая архитектура** - четкое разделение клиентской и серверной частей
3. **Масштабируемость** - использование Redis и NATS для горизонтального масштабирования
4. **Мониторинг и логирование** - комплексная система наблюдения за приложением
5. **Контейнеризация** - упрощение развертывания и изоляция компонентов
6. **Автоматизация развертывания** - использование GitHub Actions для CI/CD
7. **Четкое разделение окружений** - отдельные конфигурации для разработки и продакшна

## Области для улучшения

### Безопасность
1. **Хранение JWT** - отсутствует использование HTTP-only куки с SameSite=Strict, что повышает безопасность токенов
2. **Валидация входных данных** - требуется более строгая валидация на стороне сервера
3. **Обработка ошибок Supabase** - добавить уведомления игрокам при недоступности сервиса

### Код и архитектура
1. **Обработка ошибок** - можно улучшить обработку исключений и ошибок сети (например, недоступность Redis или Supabase)
2. **Тестирование** - недостаточное покрытие тестами (требуются Jest тесты)
3. **Дублирование логики** - логирование событий входа/выхода дублируется между клиентом и сервером без единого подхода

### Производительность
1. **Оптимизация ресурсов** - можно улучшить загрузку и кэширование ресурсов игры
2. **Ленивая загрузка** - внедрение ленивой загрузки для React-компонентов

## Структура проекта

### Корневые файлы и папки
- `.dockerignore` - файлы и папки, игнорируемые Docker
- `.editorconfig` - настройки редактора кода
- `.env` - переменные окружения
- `.eslintrc.cjs` - конфигурация ESLint
- `.gitattributes` - атрибуты Git
- `.gitignore` - файлы и папки, игнорируемые Git
- `check-versions.sh` - скрипт проверки версий зависимостей из docker-compose
- `docker-compose.dev.yml` - конфигурация Docker Compose для среды разработки
- `docker-compose.prod.yml` - конфигурация Docker Compose для среды продакшна
- `docker-compose.stage.yml` - конфигурация Docker Compose для stage среды
- `docker-compose.yml` - основная конфигурация Docker Compose
- `Dockerfile` - инструкция для сборки Docker-образа
- `index.html` - основной HTML файл
- `jest.config.js` - конфигурация Jest для тестирования
- `Makefile` - инструкции для Make
- `nginx.conf` - конфигурация Nginx
- `package.json` - зависимости и скрипты проекта
- `README.md` - основная документация проекта
- `settings.json` - конфигурация markdown-json
- `vite.config.js` - конфигурация Vite

### Папки
- `.github/` - конфигурации GitHub
  - `workflows/deploy.yml` - рабочие процессы GitHub Actions
- `alerts/` - файлы для системы оповещений
- `docker/` - файлы и конфигурации для Docker 
- `docs/` - документация проекта (jsdoc)
- `grafana/` - файлы и конфигурации для Grafana
- `logs/` - логи приложения
- `loki/` - файлы и конфигурации для Loki
- `prometheus/` - файлы и конфигурации для Prometheus
- `promtail/` - файлы и конфигурации для Promtail
- `public/` - статические файлы (favicon, robots.txt)
   - style.css - стили приложения
- `server/` - серверная часть проекта
   - `config.js` - конфигурация сервера
   - `index.js` - точка входа сервера
   - `logger.js` - настройка логирования
   - `metrics.js` - метрики Prometheus
- `src/` - клиентская часть проекта
   - `components/` - React компоненты
   - `game/` - игровая логика на Phaser
   - `hooks/` - React хуки
   - `lib/` - общие библиотеки
   - `utils/` - утилиты
   - `App.jsx` - главный компонент React
   - `main.jsx` - точка входа клиента
- `supabase` - инициализированная в проект база данных
   - `migrations/` - папка с миграциями базы данных
      - 20250316190343_init_schema.sql - миграция схемы базы данных

### Идеи для дальнейшего развития
1. Резервное копирование данных (особенно для Redis и Supabase), чтобы минимизировать риски потери данных при сбоях.
2. Добавить нагрузочные тесты (например, с помощью locust или k6), чтобы понять, как твой стек ведёт себя при большом количестве игроков.
3. Внедрить профилировщики Node.js (например, --inspect или утилиты вроде clinic.js), если есть утечки памяти в коде.
4. Провести аудит безопасности (например, с помощью npm audit или других инструментов), чтобы найти уязвимости в зависимостях.
5. Оптимизировать размеры Docker-образов (например, с помощью multi-stage builds), чтобы уменьшить время сборки и деплоя.
6. Внедрить мониторинг производительности (например, с помощью Lighthouse или Web Vitals), чтобы следить за скоростью загрузки и отзывчивостью интерфейса.
7. Провести рефакторинг кода (например, с помощью ESLint или Prettier), чтобы улучшить читаемость и поддерживаемость проекта.
8. Добавить Cypress-тесты (или другие инструменты для end-to-end тестирования), чтобы проверить, что приложение работает корректно в браузере.
9. Добавить мониторинг ошибок (например, с помощью Sentry или Rollbar), чтобы быстро реагировать на проблемы в продакшне.


## Доступные скрипты
### Разработка
- `npm run dev` - запуск клиента в режиме разработки
- `npm run server:dev` - запуск сервера в режиме разработки
- `npm run start:dev` - одновременный запуск клиента и сервера в режиме разработки

### Сборка и продакшн
- `npm run build` - сборка клиента для продакшн
- `npm run build:dev` - сборка клиента для разработки
- `npm run server:prod` - запуск сервера в продакшн режиме
- `npm run start:prod` - запуск продакшн сервера
- `npm run preview` - предпросмотр собранного клиента

### Тестирование и качество кода
- `npm test` - запуск тестов
- `npm run test:watch` - запуск тестов в режиме наблюдения
- `npm run test:coverage` - запуск тестов с отчетом о покрытии
- `npm run lint` - проверка кода линтером
- `npm run lint:fix` - исправление ошибок линтера
- `npm run format` - форматирование кода

### Доступность сервисов списком для удобства:
   - PocketBase: http://localhost:8090/
   - Supabase-studio: http://localhost:3000/
   - Prometheus: http://localhost:9090/
   - Loki: http://localhost:3100/
   - Redis: порт 6379
   - NATS: порт 4222


Общая структура проекта
Ваш проект состоит из клиентской и серверной частей, взаимодействующих через Supabase (аутентификация и база данных) и Colyseus (многопользовательская игра). Вот краткий обзор ключевых компонентов:

Клиентская часть (src/)
main.jsx: Точка входа React-приложения, рендерит App. Проблем не выявлено.
App.jsx: Управляет отображением формы аутентификации (AuthForm) или игры (PhaserGame) в зависимости от состояния isAuthenticated. Использует хук useAuth для отслеживания пользователя. Логика переключения работает корректно, но зависит от правильной работы аутентификации.
utils/logger.js: Простой логгер для клиента, проблем нет.
lib/supabase.js: Инициализирует Supabase-клиент с URL и анонимным ключом из .env. Предоставляет методы signUp, signIn, signOut и getCurrentUser. Логика создания/обновления профиля при входе и регистрации выглядит надежной.
hooks/useAuth.js: Хук для управления аутентификацией. Использует supabase.auth.onAuthStateChange для отслеживания изменений состояния пользователя. Методы signIn, signUp, signOut корректно обновляют состояние.
game/PhaserGame.jsx: Интеграция Phaser в React. Создает игру при монтировании и уничтожает при размонтировании. Зависит от состояния loading из useAuth.
game/main.js: Инициализирует Phaser с основной сценой Game.
game/scenes/Game.js: Основная сцена игры. Подключается к Colyseus через connectToRoom, загружает данные пользователя и профиля из Supabase, управляет позицией игрока.
game/scenes/HexGrid.js: Отображает гексагональную сетку и точки интереса, загруженные из Supabase.
components/AuthForm.jsx: Форма для входа и регистрации с переключением режимов. Использует useAuth для выполнения операций.
Серверная часть (server/)
index.js: Главный файл сервера. Настраивает Express, Colyseus, Supabase и Redis. Определяет комнаты hex и point.
pointRoom.js: Класс комнаты Colyseus для точек интереса. Проверяет токен в onAuth через supabase.auth.getUser и управляет состоянием игроков.
logger.js: Логирование с использованием Winston, включая вывод в консоль и файлы.
config.js: Конфигурация сервера с загрузкой переменных окружения.
admin.js: API для администрирования гексов и точек интереса.


Другие потенциальные проблемы
Синхронизация состояния аутентификации:
В useAuth.js метод signIn вручную устанавливает user, но onAuthStateChange также обновляет состояние. Это может привести к рассинхронизации, хотя в текущей логике это не должно влиять на токен.
Рекомендация: Полагайтесь только на onAuthStateChange для обновления user, убрав setUser из signIn.
Переменные окружения:
Клиент и сервер используют разные префиксы для .env (VITE_ vs без префикса). Если .env-файлы не синхронизированы, это может вызвать проблемы.
Рекомендация: Создайте единый .env.example и убедитесь, что оба окружения используют одинаковые значения.
CORS на сервере:
В index.js используется cors с настройками из config.js. Если http://localhost:3000 не указан в cors.origin, клиентские запросы могут блокироваться.
Проверка: Убедитесь, что клиентский URL разрешен в cors.origin.
Отсутствие обработки ошибок в HexGrid.js:
Если запросы к hexes или points_of_interest в Supabase не удаются, ошибки только логируются, но пользователь не уведомляется.
Рекомендация: Добавьте визуальную обратную связь через statusText в Game.js.
Жестко заданный pointId:
В connectToRoom используется фиксированный pointId: 1. Если точки с таким ID нет в базе, это может привести к ошибкам.
Рекомендация: Динамически загружайте доступные точки или добавьте обработку ошибок.
