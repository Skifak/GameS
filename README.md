# Технический README браузерной игры GameST.

## Общее описание
Проект представляет собой веб-приложение с игрой на базе Phaser.js, интегрированное с React. Архитектура включает клиентскую часть (React + Phaser) и серверную часть. Проект использует современный стек технологий и инструментов для разработки, мониторинга и развертывания.

### Основные сервисы:

1. **Клиентская часть (Frontend)**:
- **React-приложение** - основной интерфейс пользователя
- **Phaser.js** - игровой движок для создания 2D-игр
- **Vite** - инструмент сборки и разработки

2. **Серверная часть (Backend)**
- **Node.js + Express** - серверный фреймворк
- **Colyseus** - фреймворк для многопользовательских игр
- **Supabase** - база данных и система аутентификации
- **Redis** - хранилище данных в памяти
- **NATS** - система обмена сообщениями

3. **Supabase-стек**:
   - **supabase-db (PostgreSQL)** - реляционная база данных для хранения данных приложения.
   - **supabase-auth (GoTrue)** - система аутентификации и управления пользователями.
   - **supabase-studio** - веб-интерфейс для управления базой данных и пользователями.
   - **supabase-meta** - метаданные и схемы базы данных.
   - **supabase-realtime** - система для обработки и передачи данных в реальном времени.
   - **storage** - объектное хранилище для файлов и медиа.

4. **Инфраструктура, мониторинг и логирование**:
- **Docker** - контейнеризация приложения
- **Nginx** - веб-сервер и прокси
- **Prometheus** - система мониторинга
- **Grafana** - визуализация метрик
- **Loki** - система сбора и анализа логов

5. **CI/CD**
   - **GitHub Actions** - автоматизация сборки и развертывания
   - **SSH-деплой** - развертывание на удаленный сервер через SSH

### Развертывание

- Docker Compose для оркестрации контейнеров во всех трех средах
- Nginx для маршрутизации запросов
- Поддержка различных окружений (develop/stage/prod)
- GitHub Actions для автоматизации процесса развертывания
- SSH для безопасной передачи файлов и выполнения команд на сервере

### Клиентская часть
### TODO List

Структура `/src`:
- `components/` - React компоненты
   - AuthForm.jsx - форма аутентификации и регистрации
- `game/` - PhaserGame.jsx игровая логика
    - EventBus.js - событийная шина для связи React и Phaser
   - main.js - инициализация Phaser игры
   - `scenes/` - сцены игры
      - Game.js - основная игровая сцена
      - HexGrid.js - гексагональная сетка
- `hooks/` - React хуки
   - useAuth.js - хук для управления аутентификацией
- `lib/` - общие библиотеки
   - supabase.js - клиент Supabase и методы аутентификации
- `utils/` - утилиты
   - config.js - конфигурация клиента
   - logger.js - логгер для клиента
   - socket.js - клиент Colyseus (не используется в текущей реализации)
- App.jsx - корневой компонент
- main.jsx - точка входа

### Серверная часть

Структура `/server`:
config.js - конфигурация сервера
index.js - основной файл сервера
logger.js - настройка логирования
metrics.js - метрики Prometheus

#### React-компоненты
1. **App.jsx** - корневой компонент, управляющий состоянием аутентификации и взаимодействием с игрой
2. **AuthForm.jsx** - компонент для регистрации и входа пользователей
3. **PhaserGame.jsx** - компонент-обертка для интеграции Phaser с React

#### Phaser-компоненты
1. **main.js** - инициализация игры Phaser
2. **EventBus.js** - система событий для коммуникации между React и Phaser
3. **Сцены игры**:
   - HexGrid.js - основная игровая сцена с гексагональной сеткой
   - Game.js - основная сцена игры
   - Boot.js, Game.js, GameOver.js, MainMenu.js, Preloader.js - дополнительные сцены (пока не реализованы)

### Серверная часть

#### Основные модули
**index.js** - основной файл сервера, настройка Colyseus и Express
**config.js** - конфигурация сервера
**logger.js** - настройка логирования с Winston и Loki
**metrics.js** - настройка метрик Prometheus

#### Комнаты Colyseus
1. **HexRoom** - основная игровая комната с логикой многопользовательской игры(реализована в index.js)

### Утилиты
1. **logger.js** - система логирования с использованием Winston и Loki
2. **socket.js** - клиент Colyseus для подключения к серверу
3. **config.js** - централизованная конфигурация для клиента и сервера

### CI/CD Процесс
1. **deploy.yml** - конфигурация GitHub Actions для автоматического развертывания
   - Запускается при пуше в ветки main и stage на разные сервера в зависимости от ветки.
   - Собирает клиентскую часть приложения с помощью vite.
   - Развертывает на соответствующий сервер через SSH
   - Перезапускает контейнеры Docker

## Технический анализ

### Аутентификация
- Реализована система регистрации и входа через Supabase
- Используются JWT-токены с проверкой через Supabase SDK
- Отсутствует реализация эндпоинта для обновления токенов (/refresh)
- Хранение токенов осуществляется через Supabase SDK, но отсутствует явное использование HTTP-only куки с SameSite=Strict

### Многопользовательская игра
- Colyseus используется для синхронизации состояния игры между клиентами
- Реализована система комнат и подключения игроков
- Используется Redis для хранения состояния сессий (частично, требует доработки)
- Отсутствует создание новых комнат при переполнении текущей

### Логирование и мониторинг
- Winston для структурированного логирования
- Loki для централизованного хранения логов
- Prometheus для сбора метрик
- Grafana для визуализации

### Развертывание
- Docker Compose для оркестрации контейнеров
- Nginx для маршрутизации запросов
- Поддержка различных окружений (dev/stage/prod)
- GitHub Actions для автоматизации процесса развертывания
- SSH для безопасной передачи файлов и выполнения команд на сервере

## Окружения разработки

Проект поддерживает три окружения:

1. **Development** - для локальной разработки (dev, develop, development)
2. **Staging** - промежуточная среда для тестирования
3. **Production** - для конечных пользователей (использует .env + GitHub Secrets)

## Сильные стороны проекта

1. **Современный стек технологий** - использование актуальных инструментов и библиотек
2. **Хорошая архитектура** - четкое разделение клиентской и серверной частей
3. **Масштабируемость** - использование Redis и NATS для горизонтального масштабирования
4. **Мониторинг и логирование** - комплексная система наблюдения за приложением
5. **Контейнеризация** - упрощение развертывания и изоляция компонентов
6. **Автоматизация развертывания** - использование GitHub Actions для CI/CD
7. **Четкое разделение окружений** - отдельные конфигурации для разработки и продакшна

## Области для улучшения

### Безопасность
1. **Хранение JWT** - отсутствует использование HTTP-only куки с SameSite=Strict, что повышает безопасность токенов
2. **Валидация входных данных** - требуется более строгая валидация на стороне сервера
3. **Обработка ошибок Supabase** - добавить уведомления игрокам при недоступности сервиса

### Код и архитектура
1. **Обработка ошибок** - можно улучшить обработку исключений и ошибок сети (например, недоступность Redis или Supabase)
2. **Тестирование** - недостаточное покрытие тестами (требуются Jest тесты)
3. **Дублирование логики** - логирование событий входа/выхода дублируется между клиентом и сервером без единого подхода

### Производительность
1. **Оптимизация ресурсов** - можно улучшить загрузку и кэширование ресурсов игры
2. **Ленивая загрузка** - внедрение ленивой загрузки для React-компонентов

## Структура проекта

### Корневые файлы и папки
- `.dockerignore` - файлы и папки, игнорируемые Docker
- `.editorconfig` - настройки редактора кода
- `.env` - переменные окружения
- `.eslintrc.cjs` - конфигурация ESLint
- `.gitattributes` - атрибуты Git
- `.gitignore` - файлы и папки, игнорируемые Git
- `check-versions.sh` - скрипт проверки версий зависимостей из docker-compose
- `docker-compose.dev.yml` - конфигурация Docker Compose для среды разработки
- `docker-compose.prod.yml` - конфигурация Docker Compose для среды продакшна
- `docker-compose.stage.yml` - конфигурация Docker Compose для stage среды
- `docker-compose.yml` - основная конфигурация Docker Compose
- `Dockerfile` - инструкция для сборки Docker-образа
- `index.html` - основной HTML файл
- `jest.config.js` - конфигурация Jest для тестирования
- `Makefile` - инструкции для Make
- `nginx.conf` - конфигурация Nginx
- `package.json` - зависимости и скрипты проекта
- `README.md` - основная документация проекта
- `settings.json` - конфигурация markdown-json
- `vite.config.js` - конфигурация Vite

### Папки
- `.github/` - конфигурации GitHub
  - `workflows/deploy.yml` - рабочие процессы GitHub Actions
- `alerts/` - файлы для системы оповещений
- `docker/` - файлы и конфигурации для Docker 
- `docs/` - документация проекта (jsdoc)
- `grafana/` - файлы и конфигурации для Grafana
- `logs/` - логи приложения
- `loki/` - файлы и конфигурации для Loki
- `prometheus/` - файлы и конфигурации для Prometheus
- `promtail/` - файлы и конфигурации для Promtail
- `public/` - статические файлы (favicon, robots.txt)
   - style.css - стили приложения
- `server/` - серверная часть проекта
   - `config.js` - конфигурация сервера
   - `index.js` - точка входа сервера
   - `logger.js` - настройка логирования
   - `metrics.js` - метрики Prometheus
- `src/` - клиентская часть проекта
   - `components/` - React компоненты
   - `game/` - игровая логика на Phaser
   - `hooks/` - React хуки
   - `lib/` - общие библиотеки
   - `utils/` - утилиты
   - `App.jsx` - главный компонент React
   - `main.jsx` - точка входа клиента
- `supabase` - инициализированная в проект база данных
   - `migrations/` - папка с миграциями базы данных
      - 20250316190343_init_schema.sql - миграция схемы базы данных

### Идеи для дальнейшего развития
1. Резервное копирование данных (особенно для Redis и Supabase), чтобы минимизировать риски потери данных при сбоях.
2. Добавить нагрузочные тесты (например, с помощью locust или k6), чтобы понять, как твой стек ведёт себя при большом количестве игроков.
3. Внедрить профилировщики Node.js (например, --inspect или утилиты вроде clinic.js), если есть утечки памяти в коде.
4. Провести аудит безопасности (например, с помощью npm audit или других инструментов), чтобы найти уязвимости в зависимостях.
5. Оптимизировать размеры Docker-образов (например, с помощью multi-stage builds), чтобы уменьшить время сборки и деплоя.
6. Внедрить мониторинг производительности (например, с помощью Lighthouse или Web Vitals), чтобы следить за скоростью загрузки и отзывчивостью интерфейса.
7. Провести рефакторинг кода (например, с помощью ESLint или Prettier), чтобы улучшить читаемость и поддерживаемость проекта.
8. Добавить Cypress-тесты (или другие инструменты для end-to-end тестирования), чтобы проверить, что приложение работает корректно в браузере.
9. Добавить мониторинг ошибок (например, с помощью Sentry или Rollbar), чтобы быстро реагировать на проблемы в продакшне.


## Доступные скрипты
### Разработка
- `npm run dev` - запуск клиента в режиме разработки
- `npm run server:dev` - запуск сервера в режиме разработки
- `npm run start:dev` - одновременный запуск клиента и сервера в режиме разработки

### Сборка и продакшн
- `npm run build` - сборка клиента для продакшн
- `npm run build:dev` - сборка клиента для разработки
- `npm run server:prod` - запуск сервера в продакшн режиме
- `npm run start:prod` - запуск продакшн сервера
- `npm run preview` - предпросмотр собранного клиента

### Тестирование и качество кода
- `npm test` - запуск тестов
- `npm run test:watch` - запуск тестов в режиме наблюдения
- `npm run test:coverage` - запуск тестов с отчетом о покрытии
- `npm run lint` - проверка кода линтером
- `npm run lint:fix` - исправление ошибок линтера
- `npm run format` - форматирование кода

### Доступность сервисов списком для удобства:
   - PocketBase: http://localhost:8090/
   - Supabase-studio: http://localhost:3000/
   - Prometheus: http://localhost:9090/
   - Loki: http://localhost:3100/
   - Redis: порт 6379
   - NATS: порт 4222



---
# Supabase
   Обзор сервисов Supabase
Supabase состоит из множества сервисов, каждый из которых выполняет свою роль в экосистеме. Вот описание каждого из них, основанное на твоём выводе и docker-compose.yml:

1. db (PostgreSQL)
Описание: Основной сервис базы данных PostgreSQL. Это ядро Supabase, где хранятся все данные. Supabase расширяет PostgreSQL дополнительными схемами и функциями для поддержки реального времени, аутентификации и других возможностей.
Размер: ~660 MB (как указано в твоём выводе).
Необходимость: Обязателен. Без него ничего работать не будет, так как это основа всей системы.
Оптимизация: Если памяти мало, можно уменьшить настройки PostgreSQL (например, shared_buffers, work_mem) в файле volumes/db/postgresql.conf (если он монтируется), но это может повлиять на производительность.
2. meta (Postgres Meta)
Описание: Сервис для управления метаданными базы данных (схемы, таблицы, функции и т.д.). Используется Supabase Studio для предоставления интерфейса управления базой данных.
Необходимость: Нужен, если ты используешь Supabase Studio для администрирования. Если ты не планируешь использовать Studio или будешь управлять базой через другие инструменты (например, pgAdmin или CLI), можешь отключить.
Оптимизация: Отключи, если не нужен Studio. Для отключения закомментируй или удали секцию meta в docker-compose.yml.
3. analytics (Logflare)
Описание: Сервис для логирования и аналитики (Logflare). Собирает логи из других сервисов Supabase и позволяет анализировать их (например, через Studio или внешние инструменты). Может работать с PostgreSQL или Big Query как бэкенд.
Необходимость: Не обязателен, если у тебя уже есть система логирования (например, Loki из твоего основного стека). Ты можешь перенаправить логи Supabase в Loki и отключить этот сервис.
Оптимизация: Отключи, если не нужен. Для этого закомментируй или удали секцию analytics в docker-compose.yml. Также убедись, что другие сервисы не зависят от него (например, studio и auth могут зависеть от analytics для проверки состояния).
4. imgproxy
Описание: Сервис для обработки изображений (Imgproxy). Используется для динамической обработки и оптимизации изображений, загружаемых через Supabase Storage.
Необходимость: Нужен только если ты используешь Supabase Storage и тебе требуется обработка изображений (например, изменение размеров, форматов). Если ты не используешь Storage или не нуждаешься в обработке изображений, можешь отключить.
Оптимизация: Отключи, если не нужен. Для этого закомментируй или удали секцию imgproxy в docker-compose.yml. Также проверь зависимости в сервисе storage.
5. functions (Edge Functions)
Описание: Сервис для выполнения серверлесс-функций (Edge Functions). Позволяет писать кастомные функции на JavaScript/TypeScript и запускать их в изолированной среде.
Необходимость: Не обязателен, если ты не планируешь использовать серверлесс-функции. Если тебе достаточно REST API и прямых запросов к базе, можешь отключить.
Оптимизация: Отключи, если не нужен. Для этого закомментируй или удали секцию functions в docker-compose.yml.
6. vector
Описание: Сервис для сбора и передачи логов (Vector). Используется для маршрутизации логов из контейнеров Supabase в Logflare (analytics) или другие системы.
Необходимость: Не обязателен, если у тебя уже есть система логирования (например, Loki и Promtail в твоём основном стеке). Ты можешь перенаправить логи Supabase в Loki и отключить Vector.
Оптимизация: Отключи, если не нужен. Для этого закомментируй или удали секцию vector в docker-compose.yml. Также проверь зависимости (например, db зависит от vector для проверки состояния — убедись, что это не сломает запуск).
7. auth (GoTrue)
Описание: Сервис для аутентификации и авторизации (GoTrue). Отвечает за регистрацию, вход, управление пользователями, OAuth и токенами JWT.
Необходимость: Обязателен, если тебе нужна аутентификация пользователей (например, для игры). Если ты не планируешь использовать встроенную аутентификацию Supabase, можешь отключить, но это редко имеет смысл.
Оптимизация: Если аутентификация не нужна, закомментируй или удали секцию auth в docker-compose.yml.
8. supavisor (Supavisor)
Описание: Сервис для пулинга соединений (Supavisor). Оптимизирует подключения к PostgreSQL, особенно полезен при большом количестве клиентов.
Необходимость: Не обязателен для небольших проектов или если ты не ожидаешь высокой нагрузки. Для твоей игры он может быть полезен, если будет много одновременных подключений к базе.
Оптимизация: Отключи, если нагрузка небольшая. Для этого закомментируй или удали секцию supavisor в docker-compose.yml.
9. rest (PostgREST)
Описание: Сервис для предоставления REST API (PostgREST). Преобразует PostgreSQL в RESTful API, через который ты и твой фронтенд будете работать.
Необходимость: Обязателен. Это основной способ взаимодействия с базой через REST API, который ты выбрал.
Оптимизация: Нельзя отключить, так как это ключевой компонент для твоего подхода.
10. storage
Описание: Сервис для хранения файлов (Supabase Storage). Позволяет загружать, хранить и управлять файлами (например, аватары, изображения для игры).
Необходимость: Не обязателен, если ты не планируешь хранить файлы через Supabase. Если тебе достаточно базы данных, можешь отключить.
Оптимизация: Отключи, если не нужен. Для этого закомментируй или удали секцию storage в docker-compose.yml. Также отключи зависимости (например, imgproxy).
11. kong
Описание: API-шлюз (Kong). Управляет маршрутизацией запросов к различным сервисам Supabase (REST API, Realtime, Auth и т.д.).
Необходимость: Обязателен. Это точка входа для REST API и других сервисов.
Оптимизация: Нельзя отключить, так как это ключевой компонент для маршрутизации.
12. studio
Описание: Веб-интерфейс для управления Supabase (Supabase Studio). Позволяет управлять базой данных, пользователями, таблицами и т.д. через браузер.
Необходимость: Не обязателен, если ты можешь управлять базой через CLI или другие инструменты (например, pgAdmin).
Оптимизация: Отключи, если не нужен. Для этого закомментируй или удали секцию studio в docker-compose.yml. Также отключи зависимости (например, meta).
13. realtime
Описание: Сервис для работы в реальном времени (Realtime). Поддерживает подписки на изменения в базе данных через WebSocket.
Необходимость: Не обязателен, если тебе не нужны подписки в реальном времени (например, для обновления данных в игре без перезагрузки). Для твоей игры он может быть полезен, если ты хочешь моментальные обновления (например, чат или изменения состояния).
Оптимизация: Отключи, если не нужен. Для этого закомментируй или удали секцию realtime в docker-compose.yml.